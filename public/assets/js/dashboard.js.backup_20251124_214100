const { ipcRenderer } = require('electron');
const fs = require('fs');

window.onerror = function (msg, url, lineNo, columnNo, error) {
    alert('Global Error: ' + msg + '\nLine: ' + lineNo);
    return false;
};

let currentStudentId = null;
let currentStudentData = null;
let saveTimer = null;

const editorContainer = document.getElementById('editor-content');
const statusLabel = document.getElementById('status-label');
const exportBtn = document.getElementById('export-btn');
const logoutBtn = document.getElementById('logout-btn');
const userManagementBtn = document.getElementById('user-management-btn');

document.addEventListener('DOMContentLoaded', async () => {
    try {
        if (!ipcRenderer) throw new Error('ipcRenderer is not defined');

        console.log('Dashboard initializing...');
        await loadSidebar();
        console.log('Sidebar loaded.');

        // Role-Based Access Control
        const role = await ipcRenderer.invoke('get-current-user-role');
        console.log('Role loaded:', role);
        if (role !== 'admin') {
            if (userManagementBtn) userManagementBtn.style.display = 'none';
        }

        if (exportBtn) exportBtn.addEventListener('click', shareToUSB); // Legacy button if exists
        if (logoutBtn) logoutBtn.addEventListener('click', () => ipcRenderer.send('logout'));
        if (userManagementBtn) userManagementBtn.addEventListener('click', showUserManagement);
    } catch (e) {
        console.error('Dashboard Initialization Error:', e);
        alert('Critical Error: ' + e.message + '\n' + e.stack); // Use native alert for critical startup errors
    }
});

// Show user management section
function showUserManagement() {
    console.log('showUserManagement called');
    // Hide welcome screen and any student records
    const welcomeScreen = document.getElementById('welcome-screen');
    const userManagementSection = document.getElementById('user-management-section');

    console.log('User Management Section:', userManagementSection);

    // Hide all pages (student records)
    const pages = editorContainer.querySelectorAll('.paper');
    pages.forEach(page => page.style.display = 'none');

    if (welcomeScreen) welcomeScreen.style.display = 'none';
    if (userManagementSection) {
        userManagementSection.style.display = 'block';
        userManagementSection.style.visibility = 'visible';
        console.log('User management section should be visible now');
    } else {
        console.error('User management section not found!');
    }

    // Deselect any active student
    document.querySelectorAll('.student-node').forEach(n => n.classList.remove('active'));
    currentStudentId = null;
    currentStudentData = null;
    statusLabel.textContent = 'User Management';
}


let isEditMode = false;
let currentStructure = null;

async function loadSidebar() {
    currentStructure = await ipcRenderer.invoke('get-structure');
    renderTree();
}

function renderTree() {
    const treeRoot = document.getElementById('tree-root');
    treeRoot.innerHTML = '';

    // Add "Add Grade" button if in edit mode
    if (isEditMode) {
        const addGradeBtn = document.createElement('button');
        addGradeBtn.className = 'btn-primary';
        addGradeBtn.style.width = '100%';
        addGradeBtn.style.marginBottom = '10px';
        addGradeBtn.style.padding = '5px';
        addGradeBtn.style.fontSize = '12px';
        addGradeBtn.textContent = '+ Add Grade Level';
        addGradeBtn.onclick = addGrade;
        treeRoot.appendChild(addGradeBtn);
    }

    const buildTree = (obj, parent, path = []) => {
        for (const key in obj) {
            const currentPath = [...path, key];
            const li = document.createElement('li');

            // Container for the node content
            const nodeContent = document.createElement('div');
            nodeContent.style.display = 'flex';
            nodeContent.style.alignItems = 'center';
            nodeContent.style.justifyContent = 'space-between';

            if (Array.isArray(obj[key])) {
                // Leaf Node (Section -> Students)
                const details = document.createElement('details');
                const summary = document.createElement('summary');

                // Summary Content
                const summaryText = document.createElement('span');
                summaryText.textContent = key;
                summary.appendChild(summaryText);

                // Edit Controls for Section
                if (isEditMode) {
                    const controls = document.createElement('span');
                    controls.style.marginLeft = '10px';
                    controls.style.display = 'inline-flex';
                    controls.style.gap = '5px';

                    const addBtn = document.createElement('button');
                    addBtn.innerHTML = `<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="8" cy="8" r="7" fill="#28a745" stroke="#ffffff" stroke-width="1"/>
                        <path d="M8 4V12M4 8H12" stroke="white" stroke-width="2" stroke-linecap="round"/>
                    </svg>`;
                    addBtn.title = 'Add Student';
                    addBtn.style.cursor = 'pointer';
                    addBtn.style.background = 'none';
                    addBtn.style.border = 'none';
                    addBtn.style.padding = '2px';
                    addBtn.style.display = 'inline-flex';
                    addBtn.style.alignItems = 'center';
                    addBtn.onclick = (e) => { e.preventDefault(); addStudent(currentPath); };

                    const delBtn = document.createElement('button');
                    delBtn.innerHTML = `<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="8" cy="8" r="7" fill="#dc3545" stroke="#ffffff" stroke-width="1"/>
                        <path d="M5 5L11 11M11 5L5 11" stroke="white" stroke-width="2" stroke-linecap="round"/>
                    </svg>`;
                    delBtn.title = 'Delete Section';
                    delBtn.style.cursor = 'pointer';
                    delBtn.style.background = 'none';
                    delBtn.style.border = 'none';
                    delBtn.style.padding = '2px';
                    delBtn.style.display = 'inline-flex';
                    delBtn.style.alignItems = 'center';
                    delBtn.onclick = (e) => { e.preventDefault(); deleteItem(currentPath); };

                    controls.appendChild(addBtn);
                    controls.appendChild(delBtn);
                    summary.appendChild(controls);
                }

                details.appendChild(summary);

                const ul = document.createElement('ul');
                obj[key].forEach((student, index) => {
                    const sLi = document.createElement('li');
                    sLi.className = 'student-node';

                    const sContent = document.createElement('div');
                    sContent.style.display = 'flex';
                    sContent.style.justifyContent = 'space-between';
                    sContent.style.alignItems = 'center';

                    const sName = document.createElement('span');
                    sName.textContent = student.name;
                    sContent.appendChild(sName);

                    if (isEditMode) {
                        const sDel = document.createElement('button');
                        sDel.innerHTML = `<svg width="14" height="14" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="8" cy="8" r="7" fill="#dc3545" stroke="#ffffff" stroke-width="1"/>
                            <path d="M5 5L11 11M11 5L5 11" stroke="white" stroke-width="2" stroke-linecap="round"/>
                        </svg>`;
                        sDel.style.cursor = 'pointer';
                        sDel.style.background = 'none';
                        sDel.style.border = 'none';
                        sDel.style.padding = '2px';
                        sDel.style.marginLeft = '10px';
                        sDel.style.display = 'inline-flex';
                        sDel.style.alignItems = 'center';
                        sDel.onclick = (e) => {
                            e.stopPropagation();
                            deleteItem([...currentPath, index]); // Use index for array items
                        };
                        sContent.appendChild(sDel);
                    }

                    sLi.appendChild(sContent);
                    sLi.onclick = () => {
                        document.querySelectorAll('.student-node').forEach(n => n.classList.remove('active'));
                        sLi.classList.add('active');
                        loadStudent(student.id, student.name);
                    };
                    ul.appendChild(sLi);
                });
                details.appendChild(ul);
                li.appendChild(details);
            } else {
                // Branch Node (Grade/Strand)
                const details = document.createElement('details');
                const summary = document.createElement('summary');

                const summaryText = document.createElement('span');
                summaryText.textContent = key;
                summary.appendChild(summaryText);

                if (isEditMode) {
                    const controls = document.createElement('span');
                    controls.style.marginLeft = '10px';
                    controls.style.display = 'inline-flex';
                    controls.style.gap = '5px';

                    const addBtn = document.createElement('button');
                    addBtn.innerHTML = `<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="8" cy="8" r="7" fill="#28a745" stroke="#ffffff" stroke-width="1"/>
                        <path d="M8 4V12M4 8H12" stroke="white" stroke-width="2" stroke-linecap="round"/>
                    </svg>`;
                    addBtn.title = 'Add Sub-item';
                    addBtn.style.cursor = 'pointer';
                    addBtn.style.background = 'none';
                    addBtn.style.border = 'none';
                    addBtn.style.padding = '2px';
                    addBtn.style.display = 'inline-flex';
                    addBtn.style.alignItems = 'center';
                    addBtn.onclick = (e) => {
                        e.preventDefault();
                        // Determine what to add based on depth
                        if (path.length === 0) addStrand(currentPath); // Grade -> Add Strand
                        else if (path.length === 1) addSection(currentPath); // Strand -> Add Section
                    };

                    const delBtn = document.createElement('button');
                    delBtn.innerHTML = `<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="8" cy="8" r="7" fill="#dc3545" stroke="#ffffff" stroke-width="1"/>
                        <path d="M5 5L11 11M11 5L5 11" stroke="white" stroke-width="2" stroke-linecap="round"/>
                    </svg>`;
                    delBtn.title = 'Delete Item';
                    delBtn.style.cursor = 'pointer';
                    delBtn.style.background = 'none';
                    delBtn.style.border = 'none';
                    delBtn.style.padding = '2px';
                    delBtn.style.display = 'inline-flex';
                    delBtn.style.alignItems = 'center';
                    delBtn.onclick = (e) => { e.preventDefault(); deleteItem(currentPath); };

                    controls.appendChild(addBtn);
                    controls.appendChild(delBtn);
                    summary.appendChild(controls);
                }

                details.appendChild(summary);
                const ul = document.createElement('ul');
                buildTree(obj[key], ul, currentPath);
                details.appendChild(ul);
                li.appendChild(details);
            }
            parent.appendChild(li);
        }
    };

    const rootUl = document.createElement('ul');
    if (currentStructure) buildTree(currentStructure, rootUl);
    treeRoot.appendChild(rootUl);
}

// Listeners
document.getElementById('edit-structure-btn')?.addEventListener('click', () => {
    isEditMode = !isEditMode;
    const btn = document.getElementById('edit-structure-btn');
    btn.textContent = isEditMode ? '✅ Done Editing' : '✏️ Edit Structure';
    btn.style.background = isEditMode ? '#28a745' : ''; // Green when editing
    renderTree();
});

document.getElementById('refresh-tree-btn')?.addEventListener('click', loadSidebar);

async function loadStudent(id, name) {
    currentStudentId = id;

    // Hide welcome screen and user management
    const welcomeScreen = document.getElementById('welcome-screen');
    const userManagementSection = document.getElementById('user-management-section');
    if (welcomeScreen) welcomeScreen.style.display = 'none';
    if (userManagementSection) userManagementSection.style.display = 'none';

    // Remove existing papers
    const existingPages = editorContainer.querySelectorAll('.paper');
    existingPages.forEach(p => p.remove());

    // Show loading
    let loader = document.getElementById('student-loader');
    if (!loader) {
        loader = document.createElement('div');
        loader.id = 'student-loader';
        loader.style.textAlign = 'center';
        loader.style.padding = '50px';
        loader.textContent = 'Loading...';
        editorContainer.appendChild(loader);
    }
    loader.style.display = 'block';

    let data = await ipcRenderer.invoke('load-student', id);
    if (!data) data = generateEmptyRecord(id, name);
    currentStudentData = data;

    // Hide loader before rendering
    loader.style.display = 'none';
    renderForm();
}

function generateEmptyRecord(id, name) {
    let lname = '', fname = '';
    if (name && name.includes(',')) {
        [lname, fname] = name.split(',').map(s => s.trim());
    } else if (name) {
        fname = name.trim();
    }

    const makeSem = () => ({
        school: '', schoolId: '', gradeLevel: '', sy: '', sem: '',
        trackStrand: '', section: '',
        subjects: Array.from({ length: 16 }, () => ({ type: '', subject: '', q1: '', q2: '', final: '', action: '' })),
        genAve: '', remarks: '', adviserName: '', certName: '', dateChecked: '',
        remedial: {
            from: '', to: '', school: '', schoolId: '',
            subjects: Array.from({ length: 8 }, () => ({ type: '', subject: '', semGrade: '', remedialMark: '', recomputedGrade: '', action: '' })),
            teacherName: ''
        }
    });

    return {
        info: { lname, fname, mname: '', lrn: '', sex: '', birthdate: '', admissionDate: '' },
        eligibility: {
            hsCompleter: false, hsGenAve: '', jhsCompleter: false, jhsGenAve: '',
            gradDate: '', schoolName: '', schoolAddress: '',
            pept: false, peptRating: '', als: false, alsRating: '',
            examDate: '', clcName: '', othersSpec: ''
        },
        semester1: makeSem(),
        semester2: makeSem(),
        semester3: makeSem(),
        semester4: makeSem(),
        certification: { trackStrand: '', genAve: '', awards: '', gradDate: '', schoolHead: '', certDate: '', remarks: '', dateIssued: '' }
    };
}

function renderForm() {
    // Hide welcome/user-management/loader just in case
    const welcomeScreen = document.getElementById('welcome-screen');
    const userManagementSection = document.getElementById('user-management-section');
    const loader = document.getElementById('student-loader');

    if (welcomeScreen) welcomeScreen.style.display = 'none';
    if (userManagementSection) userManagementSection.style.display = 'none';
    if (loader) loader.style.display = 'none';

    // Remove old papers
    const existingPages = editorContainer.querySelectorAll('.paper');
    existingPages.forEach(p => p.remove());

    const d = currentStudentData;

    // Ensure all semesters exist (for backward compatibility)
    if (!d.semester3) d.semester3 = generateEmptyRecord().semester1;
    if (!d.semester4) d.semester4 = generateEmptyRecord().semester1;

    // === PAGE 1: Header + Learner Info + Eligibility + Semesters 1 & 2 ===
    const page1 = document.createElement('div');
    page1.className = 'paper';
    page1.innerHTML = `
        <table style="width:100%; border-collapse:collapse; margin-bottom:1px;">
            <tr>
                <td width="45" style="border:none;"><img src="assets/images/deped_logo.webp" width="40"></td>
                <td style="border:none; text-align:center; font-size:6pt; line-height:1;">
                    <div>REPUBLIC OF THE PHILIPPINES</div>
                    <div style="font-weight:bold;">DEPARTMENT OF EDUCATION</div>
                    <div style="font-weight:bold; font-size:7pt;">SENIOR HIGH SCHOOL STUDENT PERMANENT RECORD</div>
                </td>
                <td width="60" style="border:none; text-align:right; font-size:11pt; font-weight:bold; line-height:0.8;">FORM 137-<br>SHS</td>
            </tr>
        </table>

        <div class="hdr">LEARNER'S INFORMATION</div>
        <table class="form clean-tbl">
            <tr>
                <td width="33%" class="flex-cell">LAST NAME:&nbsp;<input class="flex-inp" value="${d.info.lname}" oninput="up('info','lname',this.value)"></td>
                <td width="34%" class="flex-cell">FIRST NAME:&nbsp;<input class="flex-inp" value="${d.info.fname}" oninput="up('info','fname',this.value)"></td>
                <td width="33%" class="flex-cell">MIDDLE NAME:&nbsp;<input class="flex-inp" value="${d.info.mname}" oninput="up('info','mname',this.value)"></td>
            </tr>
            <tr>
                <td class="flex-cell">LRN:&nbsp;<input class="flex-inp" value="${d.info.lrn}" oninput="up('info','lrn',this.value)"></td>
                <td colspan="2" class="flex-cell">Date of Birth (mm/dd/yyyy):&nbsp;<input class="flex-inp" value="${d.info.birthdate}" oninput="up('info','birthdate',this.value)"></td>
            </tr>
            <tr>
                <td class="flex-cell">Sex:&nbsp;<input class="flex-inp" value="${d.info.sex}" oninput="up('info','sex',this.value)"></td>
                <td colspan="2" class="flex-cell">Date of SHS Admission (mm/dd/yyyy):&nbsp;<input class="flex-inp" value="${d.info.admissionDate}" oninput="up('info','admissionDate',this.value)"></td>
            </tr>
        </table>

        <div class="hdr">ELIGIBILITY FOR SHS ENROLMENT</div>
        <table class="form clean-tbl" style="font-size:5.5pt;">
            <tr>
                <td width="18%"><input type="checkbox" ${d.eligibility.hsCompleter ? 'checked' : ''} onchange="up('eligibility','hsCompleter',this.checked)"> High School Completer*</td>
                <td width="14%" class="flex-cell">Gen. Ave:&nbsp;<input class="flex-inp" value="${d.eligibility.hsGenAve}" oninput="up('eligibility','hsGenAve',this.value)"></td>
                <td width="18%"><input type="checkbox" ${d.eligibility.jhsCompleter ? 'checked' : ''} onchange="up('eligibility','jhsCompleter',this.checked)"> JHS Completer</td>
                <td width="14%" class="flex-cell">Gen. Ave:&nbsp;<input class="flex-inp" value="${d.eligibility.jhsGenAve}" oninput="up('eligibility','jhsGenAve',this.value)"></td>
                <td width="36%" class="flex-cell"><input type="checkbox" ${d.eligibility.others ? 'checked' : ''} onchange="up('eligibility','others',this.checked)"> Others:&nbsp;<input class="flex-inp" value="${d.eligibility.othersSpec}" oninput="up('eligibility','othersSpec',this.value)"></td>
            </tr>
            <tr>
                <td colspan="2">Date of Graduation: <input class="inp" value="${d.eligibility.gradDate}" oninput="up('eligibility','gradDate',this.value)" style="width: 60%; display: inline-block; border-bottom: 1px solid #000;"></td>
                <td class="flex-cell">Name of School:&nbsp;<input class="flex-inp" value="${d.eligibility.schoolName}" oninput="up('eligibility','schoolName',this.value)"></td>
                <td colspan="2" class="flex-cell">School Address:&nbsp;<input class="flex-inp" value="${d.eligibility.schoolAddress}" oninput="up('eligibility','schoolAddress',this.value)"></td>
           </tr>
            <tr>
                <td width="18%"><input type="checkbox" ${d.eligibility.pept ? 'checked' : ''} onchange="up('eligibility','pept',this.checked)"> PEPT Passer**</td>
                <td width="14%" class="flex-cell">Rating:&nbsp;<input class="flex-inp" value="${d.eligibility.peptRating}" oninput="up('eligibility','peptRating',this.value)"></td>
                <td width="18%"><input type="checkbox" ${d.eligibility.als ? 'checked' : ''} onchange="up('eligibility','als',this.checked)"> ALS A&E***</td>
                <td colspan="2" class="flex-cell">Rating:&nbsp;<input class="flex-inp" value="${d.eligibility.alsRating}" oninput="up('eligibility','alsRating',this.value)"></td>
            </tr>
            <tr>
                <td colspan="2">Date of Exam: <input class="inp" value="${d.eligibility.examDate}" oninput="up('eligibility','examDate',this.value)" style="width: 60%; display: inline-block; border-bottom: 1px solid #000;"></td>
                <td colspan="3" class="flex-cell">CLC Name and Address:&nbsp;<input class="flex-inp" value="${d.eligibility.clcName}" oninput="up('eligibility','clcName',this.value)"></td>
            </tr>
            <tr style="font-size:5pt; font-style:italic;">
                <td colspan="2">*HS Completers graduated under old curriculum</td>
                <td colspan="3">***ALS A&E - Alternative Learning System Accred. & Equiv. Test</td>
            </tr>
            <tr style="font-size:5pt; font-style:italic;">
                <td colspan="5">**PEPT - Philippine Educational Placement Test</td>
            </tr>
        </table>

        ${renderSemester(d.semester1, 'semester1')}
        ${renderSemester(d.semester2, 'semester2')}
    `;
    editorContainer.appendChild(page1);

    // === PAGE 2: Semesters 3 & 4 + Certification ===
    const page2 = document.createElement('div');
    page2.className = 'paper';
    page2.innerHTML = `
        <div style="text-align:right; font-size:6pt; margin-bottom:3px;">Page 2 &nbsp; Form 137-SHS</div>
        ${renderSemester(d.semester3, 'semester3')}
        ${renderSemester(d.semester4, 'semester4')}
        
        <table class="form clean-tbl">
            <tr>
                <td width="70%" class="flex-cell">Track/Strand Accomplished:&nbsp;<input class="flex-inp" value="${d.certification.trackStrand}" oninput="up('certification','trackStrand',this.value)"></td>
                <td width="30%" class="flex-cell">SHS General Average:&nbsp;<input class="flex-inp" value="${d.certification.genAve}" oninput="up('certification','genAve',this.value)"></td>
            </tr>
            <tr>
                <td class="flex-cell">Awards/Honors Received:&nbsp;<input class="flex-inp" value="${d.certification.awards}" oninput="up('certification','awards',this.value)"></td>
                <td class="flex-cell">Date of SHS Graduation:&nbsp;<input type="date" class="flex-inp" value="${d.certification.gradDate}" oninput="up('certification','gradDate',this.value)"></td>
            </tr>
        </table>

        <div style="border:1px solid #000; padding:3px; margin-top:2px; font-size:5.5pt;">
            <strong>Certified by:</strong>
            <div style="padding:12px 0 4px; text-align:center;">
                <div style="display:inline-block; width:220px; border-bottom:1px solid #000; margin-bottom:1px;"></div>
                <div style="font-size:5pt;">Signature of School Head over Printed Name</div>
                <div style="margin-top:6px; font-size:5.5pt;">Date: <input type="date" class="inp" value="${d.certification.certDate}" oninput="up('certification','certDate',this.value)" style="width:80px; border-bottom:1px solid #000;"></div>
            </div>
            <div style="text-align:right; margin-top:6px; font-size:5pt;">Place School Seal Here:</div>
        </div>

        <div style="border:1px solid #000; padding:2px; margin-top:2px; background:#f5f5f5;">
            <div style="font-weight:bold; font-size:5.5pt;">NOTE:</div>
            <div style="font-size:5pt;">This permanent record or a photocopy may be given to the student upon written request.</div>
        </div>

        <div style="border:1px solid #000; padding:2px; margin-top:2px;">
            <div style="font-weight:bold; font-size:5.5pt;">REMARKS: (Purpose for which this form is being requested)</div>
            <textarea class="inp" style="min-height:25px; font-size:5.5pt;" oninput="up('certification','remarks',this.value)">${d.certification.remarks}</textarea>
            <div style="font-size:5.5pt;">Date Issued (MM/DD/YYYY): <input type="date" class="inp" value="${d.certification.dateIssued}" oninput="up('certification','dateIssued',this.value)" style="width:80px; border-bottom:1px solid #000;"></div>
        </div>
    `;
    editorContainer.appendChild(page2);
}

function renderSemester(sem, key) {
    return `
        <div class="hdr">SCHOLASTIC RECORD</div>
        <table class="form clean-tbl">
            <tr>
                <td width="43%" class="flex-cell">SCHOOL:&nbsp;<input class="flex-inp" value="${sem.school}" oninput="upSem('${key}','school',this.value)"></td>
                <td width="18%" class="flex-cell">SCHOOL ID:&nbsp;<input class="flex-inp" value="${sem.schoolId}" oninput="upSem('${key}','schoolId',this.value)"></td>
                <td width="18%" class="flex-cell">GRADE LEVEL:&nbsp;<input class="flex-inp" value="${sem.gradeLevel}" oninput="upSem('${key}','gradeLevel',this.value)"></td>
                <td width="21%" class="flex-cell">SY:&nbsp;<input class="flex-inp" value="${sem.sy}" oninput="upSem('${key}','sy',this.value)"></td>
            </tr>
            <tr>
                <td colspan="3" class="flex-cell">TRACK/STRAND:&nbsp;<input class="flex-inp" value="${sem.trackStrand}" oninput="upSem('${key}','trackStrand',this.value)"></td>
                <td class="flex-cell">SEM:&nbsp;<input class="flex-inp" value="${sem.sem}" oninput="upSem('${key}','sem',this.value)"></td>
            </tr>
            <tr>
                <td colspan="4" class="flex-cell">SECTION:&nbsp;<input class="flex-inp" value="${sem.section}" oninput="upSem('${key}','section',this.value)"></td>
            </tr>
        </table>

        <table class="form" style="font-size:5.5pt;">
            <thead>
                <tr>
                    <th rowspan="2" width="15%">CORE/APPLIED/SPECIALIZED</th>
                    <th rowspan="2" width="42%">SUBJECTS</th>
                    <th colspan="2" width="14%">Quarter</th>
                    <th rowspan="2" width="11%">SEM FINAL</th>
                    <th rowspan="2" width="12%">ACTION TAKEN</th>
                </tr>
                <tr><th width="7%">1ST</th><th width="7%">2ND</th></tr>
            </thead>
            <tbody>
                ${sem.subjects.map((s, i) => `
                    <tr>
                        <td><input class="inp c" value="${s.type}" oninput="upSub('${key}',${i},'type',this.value)"></td>
                        <td><input class="inp" value="${s.subject}" oninput="upSub('${key}',${i},'subject',this.value)"></td>
                        <td><input class="inp c" value="${s.q1}" oninput="upSub('${key}',${i},'q1',this.value)"></td>
                        <td><input class="inp c" value="${s.q2}" oninput="upSub('${key}',${i},'q2',this.value)"></td>
                        <td><input class="inp c" value="${s.final}" oninput="upSub('${key}',${i},'final',this.value)"></td>
                        <td><input class="inp c" value="${s.action}" oninput="upSub('${key}',${i},'action',this.value)"></td>
                    </tr>
                `).join('')}
            </tbody>
        </table>

        <table class="form">
            <tr><td class="lbl" width="22%">General Ave. for the Semester:</td><td><input class="inp" value="${sem.genAve}" oninput="upSem('${key}','genAve',this.value)"></td></tr>
            <tr><td class="lbl">REMARKS:</td><td><textarea class="inp" style="height:25px; vertical-align:top;" oninput="upSem('${key}','remarks',this.value)">${sem.remarks}</textarea></td></tr>
        </table>

        <table class="form" style="font-size:5.5pt;">
            <tr>
                <td width="33%">Prepared by: <input class="inp" value="${sem.adviserName}" oninput="upSem('${key}','adviserName',this.value)"></td>
                <td width="34%">Certified: <input class="inp" value="${sem.certName}" oninput="upSem('${key}','certName',this.value)"></td>
                <td width="33%">Date Checked: <input class="inp" value="${sem.dateChecked}" oninput="upSem('${key}','dateChecked',this.value)"></td>
            </tr>
            <tr><td colspan="3" class="c" style="padding-top:5px; font-size:5pt; font-style:italic;">Signature of Adviser over Printed Name &nbsp; Signature of Authorized Person over Printed Name</td></tr>
        </table>

        <div class="hdr" style="background:#f0f0f0;">REMEDIAL CLASSES</div>
        <table class="form clean-tbl" style="font-size:5.5pt;">
            <tr>
                <td colspan="2">Conducted from: <input class="inp" value="${sem.remedial.from}" oninput="upRem('${key}','from',this.value)" style="width:50px;"></td>
                <td>to: <input class="inp" value="${sem.remedial.to}" oninput="upRem('${key}','to',this.value)" style="width:50px;"></td>
                <td class="lbl">SCHOOL:</td><td><input class="inp" value="${sem.remedial.school}" oninput="upRem('${key}','school',this.value)"></td>
                <td class="lbl">SCHOOL ID:</td><td><input class="inp" value="${sem.remedial.schoolId}" oninput="upRem('${key}','schoolId',this.value)"></td>
            </tr>
        </table>
        <table class="form" style="font-size:5.5pt;">
            <thead>
                <tr>
                    <th width="15%">CORE/APPLIED/SPECIALIZED</th>
                    <th width="39%">SUBJECTS</th>
                    <th width="11%">SEM FINAL</th>
                    <th width="12%">REMEDIAL MARK</th>
                    <th width="13%">RECOMPUTED</th>
                    <th width="10%">ACTION</th>
                </tr>
            </thead>
            <tbody>
                ${sem.remedial.subjects.map((rs, ri) => `
                    <tr>
                        <td><input class="inp c" value="${rs.type}" oninput="upRemSub('${key}',${ri},'type',this.value)"></td>
                        <td><input class="inp" value="${rs.subject}" oninput="upRemSub('${key}',${ri},'subject',this.value)"></td>
                        <td><input class="inp c" value="${rs.semGrade}" oninput="upRemSub('${key}',${ri},'semGrade',this.value)"></td>
                        <td><input class="inp c" value="${rs.remedialMark}" oninput="upRemSub('${key}',${ri},'remedialMark',this.value)"></td>
                        <td><input class="inp c" value="${rs.recomputedGrade}" oninput="upRemSub('${key}',${ri},'recomputedGrade',this.value)"></td>
                        <td><input class="inp c" value="${rs.action}" oninput="upRemSub('${key}',${ri},'action',this.value)"></td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
        <table class="form" style="font-size:5.5pt;">
            <tr><td width="50%">Name of Teacher/Adviser: <input class="inp" value="${sem.remedial.teacherName}" oninput="upRem('${key}','teacherName',this.value)"></td><td>Signature:</td></tr>
        </table>
    `;
}

function up(section, field, val) {
    currentStudentData[section][field] = val;
    save();
}
function upSem(semKey, field, val) {
    currentStudentData[semKey][field] = val;
    save();
}
function upSub(semKey, idx, field, val) {
    currentStudentData[semKey].subjects[idx][field] = val;
    save();
}
function upRem(semKey, field, val) {
    currentStudentData[semKey].remedial[field] = val;
    save();
}
function upRemSub(semKey, idx, field, val) {
    currentStudentData[semKey].remedial.subjects[idx][field] = val;
    save();
}

function save() {
    statusLabel.innerText = "Unsaved...";
    statusLabel.style.color = "orange";
    clearTimeout(saveTimer);
    saveTimer = setTimeout(async () => {
        statusLabel.innerText = "Saving...";
        await ipcRenderer.invoke('save-student', { id: currentStudentId, data: currentStudentData });
        statusLabel.innerText = "Saved";
        statusLabel.style.color = "green";
    }, 1000);
}

async function shareToUSB() {
    const drives = await ipcRenderer.invoke('scan-usb');
    if (!drives.length) {
        await customAlert("No USB found.");
        return;
    }
    const drive = drives[0];
    if (!confirm(`Export to ${drive.label}?`)) return;
    const content = `<html><head><title>${currentStudentData.info.lname} - Form 137</title>
    <style>${fs.readFileSync('assets/css/form137.css', 'utf8')}</style></head>
    <body>${editorContainer.innerHTML}</body></html>`;
    const result = await ipcRenderer.invoke('export-file', {
        path: drive.path,
        filename: `Form137_${currentStudentData.info.lname}.html`,
        content
    });
    await customAlert(result.success ? "Export successful!" : "Export failed: " + result.error);
}

window.up = up;
window.upSem = upSem;
window.upSub = upSub;
window.upRem = upRem;
window.upRemSub = upRemSub;

// --- STRUCTURE MANAGEMENT HELPERS ---

function saveStructure() {
    ipcRenderer.send('update-structure', currentStructure);
    loadSidebar(); // Refresh tree
}

// Custom prompt replacement (Electron doesn't support native prompt())
function customPrompt(title) {
    return new Promise((resolve) => {
        const modal = document.getElementById('custom-prompt-modal');
        const titleEl = document.getElementById('custom-prompt-title');
        const inputEl = document.getElementById('custom-prompt-input');
        const okBtn = document.getElementById('custom-prompt-ok');
        const cancelBtn = document.getElementById('custom-prompt-cancel');

        titleEl.textContent = title;
        inputEl.value = '';
        modal.style.display = 'flex';

        // Use setTimeout to ensure modal is visible before focusing
        setTimeout(() => inputEl.focus(), 50);

        let resolved = false;

        const cleanup = (value) => {
            if (resolved) return; // Prevent double resolution
            resolved = true;

            modal.style.display = 'none';
            okBtn.removeEventListener('click', handleOk);
            cancelBtn.removeEventListener('click', handleCancel);
            inputEl.removeEventListener('keydown', handleKeydown);
            resolve(value);
        };

        const handleOk = () => cleanup(inputEl.value.trim() || null);
        const handleCancel = () => cleanup(null);
        const handleKeydown = (e) => {
            if (e.key === 'Enter') handleOk();
            if (e.key === 'Escape') handleCancel();
        };

        okBtn.addEventListener('click', handleOk);
        cancelBtn.addEventListener('click', handleCancel);
        inputEl.addEventListener('keydown', handleKeydown);
    });
}

// Custom alert replacement
function customAlert(message) {
    return new Promise((resolve) => {
        const modal = document.getElementById('custom-alert-modal');
        const messageEl = document.getElementById('custom-alert-message');
        const okBtn = document.getElementById('custom-alert-ok');

        messageEl.textContent = message;
        modal.style.display = 'flex';

        // Focus OK button for keyboard accessibility
        setTimeout(() => okBtn.focus(), 50);

        const cleanup = () => {
            modal.style.display = 'none';
            okBtn.removeEventListener('click', handleOk);
            document.removeEventListener('keydown', handleKeydown);
            resolve();
        };

        const handleOk = () => cleanup();
        const handleKeydown = (e) => {
            if (e.key === 'Enter' || e.key === 'Escape') handleOk();
        };

        okBtn.addEventListener('click', handleOk);
        document.addEventListener('keydown', handleKeydown);
    });
}

async function addGrade() {
    const name = await customPrompt("Enter Grade Level Name (e.g., Grade 11):");
    if (!name) return;
    if (currentStructure[name]) {
        await customAlert("Grade Level already exists.");
        return;
    }
    currentStructure[name] = {};
    saveStructure();
}

async function addStrand(path) {
    const name = await customPrompt("Enter Strand Name (e.g., TVL - ICT):");
    if (!name) return;
    if (currentStructure[path[0]][name]) {
        await customAlert("Strand already exists.");
        return;
    }
    currentStructure[path[0]][name] = {};
    saveStructure();
}

async function addSection(path) {
    const name = await customPrompt("Enter Section Name (e.g., Section A):");
    if (!name) return;
    if (currentStructure[path[0]][path[1]][name]) {
        await customAlert("Section already exists.");
        return;
    }
    currentStructure[path[0]][path[1]][name] = [];
    saveStructure();
}

async function addStudent(path) {
    const name = await customPrompt("Enter Student Name (Last Name, First Name):");
    if (!name) return;
    const id = Date.now().toString(); // Simple ID generation
    currentStructure[path[0]][path[1]][path[2]].push({ id, name });
    saveStructure();
}

function deleteItem(path) {
    if (!confirm("Are you sure you want to delete this item? This cannot be undone.")) return;

    if (path.length === 1) { // Delete Grade
        delete currentStructure[path[0]];
    } else if (path.length === 2) { // Delete Strand
        delete currentStructure[path[0]][path[1]];
    } else if (path.length === 3) { // Delete Section
        delete currentStructure[path[0]][path[1]][path[2]];
    } else if (path.length === 4) { // Delete Student
        // path[3] is the index
        currentStructure[path[0]][path[1]][path[2]].splice(path[3], 1);
    }
    saveStructure();
}

// --- SHARE FEATURE ---

const shareModal = document.getElementById('share-modal');
const shareBtn = document.getElementById('share-btn');
const closeShareBtn = document.getElementById('close-share-modal');
const shareUsbBtn = document.getElementById('share-usb-btn');
const shareFileBtn = document.getElementById('share-file-btn');
const importBtn = document.getElementById('import-btn');

if (shareBtn) shareBtn.addEventListener('click', async () => {
    if (!currentStudentData) {
        await customAlert("Please select a student first.");
        return;
    }
    shareModal.style.display = 'flex';
});

if (closeShareBtn) closeShareBtn.addEventListener('click', () => {
    shareModal.style.display = 'none';
});

if (shareUsbBtn) shareUsbBtn.addEventListener('click', exportToUSB);
if (shareFileBtn) shareFileBtn.addEventListener('click', exportToFile);
if (importBtn) importBtn.addEventListener('click', importStudent);

async function exportToUSB() {
    const drives = await ipcRenderer.invoke('scan-usb');
    if (!drives.length) {
        await customAlert("No USB found.");
        return;
    }
    const drive = drives[0];
    if (!confirm(`Export to ${drive.label}?`)) return;

    // 1. Export HTML (for printing)
    const htmlContent = `<html><head><title>${currentStudentData.info.lname} - Form 137</title>
    <style>${fs.readFileSync('assets/css/form137.css', 'utf8')}</style></head>
    <body>${editorContainer.innerHTML}</body></html>`;

    await ipcRenderer.invoke('export-file', {
        path: drive.path,
        filename: `Form137_${currentStudentData.info.lname}.html`,
        content: htmlContent
    });

    // 2. Export JSON (for importing)
    await ipcRenderer.invoke('export-file', {
        path: drive.path,
        filename: `StudentData_${currentStudentData.info.lname}.json`,
        content: JSON.stringify(currentStudentData, null, 2)
    });

    await customAlert("Export successful! Saved HTML and JSON to USB.");
    shareModal.style.display = 'none';
}

async function exportToFile() {
    const defaultName = `StudentData_${currentStudentData.info.lname}.json`;
    const filePath = await ipcRenderer.invoke('save-file-dialog', defaultName);
    if (!filePath) return;

    require('fs').writeFileSync(filePath, JSON.stringify(currentStudentData, null, 2));
    await customAlert("Export successful! You can now share this file via Bluetooth or Hotspot.");
    shareModal.style.display = 'none';
}

async function importStudent() {
    const filePath = await ipcRenderer.invoke('open-file-dialog');
    if (!filePath) return;

    const content = await ipcRenderer.invoke('read-file', filePath);
    if (!content) {
        await customAlert("Failed to read file.");
        return;
    }

    try {
        const studentData = JSON.parse(content);
        const name = `${studentData.info.lname}, ${studentData.info.fname}`;
        const id = studentData.id || Date.now().toString(); // Use existing ID or generate new

        // Determine Structure Placement (Grade -> Strand -> Section)
        // Try to find info in Semester 1, or default
        let grade = studentData.semester1.gradeLevel || "Unassigned Grade";
        let strand = studentData.semester1.trackStrand || "Unassigned Strand";
        let section = studentData.semester1.section || "Unassigned Section";

        // Auto-Create Structure
        if (!currentStructure[grade]) currentStructure[grade] = {};
        if (!currentStructure[grade][strand]) currentStructure[grade][strand] = {};
        if (!currentStructure[grade][strand][section]) currentStructure[grade][strand][section] = [];

        // Check if student already exists in this section
        const exists = currentStructure[grade][strand][section].find(s => s.name === name);
        if (exists) {
            if (!confirm(`Student ${name} already exists in ${grade} - ${section}. Overwrite?`)) return;
            // Update ID if overwriting? Or just keep existing?
            // Let's assume we update the record data but keep the structure entry
        } else {
            currentStructure[grade][strand][section].push({ id, name });
            saveStructure(); // Updates sidebar
        }

        // Save Student Record
        await ipcRenderer.invoke('save-student', { id, data: studentData });

        await customAlert(`Imported ${name} successfully!`);
        loadSidebar(); // Refresh tree
        loadStudent(id, name); // Load the imported student

    } catch (e) {
        await customAlert("Invalid Student Data File: " + e.message);
    }
}

// Print Button Handler
const printBtn = document.getElementById('print-record-btn');
if (printBtn) {
    printBtn.addEventListener('click', async () => {
        if (!currentStudentId || !currentStudentData) {
            await customAlert('Please select a student to print their record.');
            return;
        }
        // Save data for the print window to access
        localStorage.setItem('printStudentData', JSON.stringify(currentStudentData));

        // Open print preview in a new window
        const printWindow = window.open('print-preview.html', '_blank', 'width=1000,height=800,menubar=no,toolbar=no,location=no,status=no');

        if (!printWindow) {
            await customAlert('Pop-up blocked! Please allow pop-ups for this application.');
        }
    });
}
