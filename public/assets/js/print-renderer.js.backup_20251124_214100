document.addEventListener('DOMContentLoaded', () => {
    const printContent = document.getElementById('print-content');
    const btnPrint = document.getElementById('do-print');
    const btnClose = document.getElementById('do-close');

    // Load data from localStorage
    const rawData = localStorage.getItem('printStudentData');
    if (!rawData) {
        printContent.innerHTML = '<div style="padding: 20px; text-align: center; color: red;">No student data found for printing.</div>';
        return;
    }

    const d = JSON.parse(rawData);
    renderPrintForm(d, printContent);

    // Event Listeners
    if (btnPrint) {
        btnPrint.addEventListener('click', () => {
            window.print();
        });
    }

    if (btnClose) {
        btnClose.addEventListener('click', () => {
            window.close();
        });
    }
});

function renderPrintForm(d, container) {
    // Ensure all semesters exist
    if (!d.semester3) d.semester3 = d.semester1; // Fallback structure if missing
    if (!d.semester4) d.semester4 = d.semester1;

    // === PAGE 1 ===
    const page1 = document.createElement('div');
    page1.className = 'paper';
    page1.innerHTML = `
        <table style="width:100%; border-collapse:collapse; margin-bottom:1px;">
            <tr>
                <td width="45" style="border:none;"><img src="assets/images/deped_logo.webp" width="40"></td>
                <td style="border:none; text-align:center; font-size:6pt; line-height:1;">
                    <div>REPUBLIC OF THE PHILIPPINES</div>
                    <div style="font-weight:bold;">DEPARTMENT OF EDUCATION</div>
                    <div style="font-weight:bold; font-size:7pt;">SENIOR HIGH SCHOOL STUDENT PERMANENT RECORD</div>
                </td>
                <td width="60" style="border:none; text-align:right; font-size:11pt; font-weight:bold; line-height:0.8;">FORM 137-<br>SHS</td>
            </tr>
        </table>

        <div class="hdr">LEARNER'S INFORMATION</div>
        <table class="form clean-tbl">
            <tr>
                <td width="33%" class="flex-cell">LAST NAME:&nbsp;<input class="flex-inp" value="${d.info.lname}" disabled></td>
                <td width="34%" class="flex-cell">FIRST NAME:&nbsp;<input class="flex-inp" value="${d.info.fname}" disabled></td>
                <td width="33%" class="flex-cell">MIDDLE NAME:&nbsp;<input class="flex-inp" value="${d.info.mname}" disabled></td>
            </tr>
            <tr>
                <td class="flex-cell">LRN:&nbsp;<input class="flex-inp" value="${d.info.lrn}" disabled></td>
                <td colspan="2" class="flex-cell">Date of Birth (mm/dd/yyyy):&nbsp;<input class="flex-inp" value="${d.info.birthdate}" disabled></td>
            </tr>
            <tr>
                <td class="flex-cell">Sex:&nbsp;<input class="flex-inp" value="${d.info.sex}" disabled></td>
                <td colspan="2" class="flex-cell">Date of SHS Admission (mm/dd/yyyy):&nbsp;<input class="flex-inp" value="${d.info.admissionDate}" disabled></td>
            </tr>
        </table>

        <div class="hdr">ELIGIBILITY FOR SHS ENROLMENT</div>
        <table class="form clean-tbl" style="font-size:5.5pt;">
            <tr>
                <td width="18%"><input type="checkbox" ${d.eligibility.hsCompleter ? 'checked' : ''} disabled> High School Completer*</td>
                <td width="14%" class="flex-cell">Gen. Ave:&nbsp;<input class="flex-inp" value="${d.eligibility.hsGenAve}" disabled></td>
                <td width="18%"><input type="checkbox" ${d.eligibility.jhsCompleter ? 'checked' : ''} disabled> JHS Completer</td>
                <td width="14%" class="flex-cell">Gen. Ave:&nbsp;<input class="flex-inp" value="${d.eligibility.jhsGenAve}" disabled></td>
                <td width="36%" class="flex-cell"><input type="checkbox" ${d.eligibility.others ? 'checked' : ''} disabled> Others:&nbsp;<input class="flex-inp" value="${d.eligibility.othersSpec}" disabled></td>
            </tr>
            <tr>
                <td colspan="2">Date of Graduation: <input class="inp" value="${d.eligibility.gradDate}" disabled style="width: 60%; display: inline-block; border-bottom: 1px solid #000;"></td>
                <td class="flex-cell">Name of School:&nbsp;<input class="flex-inp" value="${d.eligibility.schoolName}" disabled></td>
                <td colspan="2" class="flex-cell">School Address:&nbsp;<input class="flex-inp" value="${d.eligibility.schoolAddress}" disabled></td>
           </tr>
            <tr>
                <td width="18%"><input type="checkbox" ${d.eligibility.pept ? 'checked' : ''} disabled> PEPT Passer**</td>
                <td width="14%" class="flex-cell">Rating:&nbsp;<input class="flex-inp" value="${d.eligibility.peptRating}" disabled></td>
                <td width="18%"><input type="checkbox" ${d.eligibility.als ? 'checked' : ''} disabled> ALS A&E***</td>
                <td colspan="2" class="flex-cell">Rating:&nbsp;<input class="flex-inp" value="${d.eligibility.alsRating}" disabled></td>
            </tr>
            <tr>
                <td colspan="2">Date of Exam: <input class="inp" value="${d.eligibility.examDate}" disabled style="width: 60%; display: inline-block; border-bottom: 1px solid #000;"></td>
                <td colspan="3" class="flex-cell">CLC Name and Address:&nbsp;<input class="flex-inp" value="${d.eligibility.clcName}" disabled></td>
            </tr>
            <tr style="font-size:5pt; font-style:italic;">
                <td colspan="2">*HS Completers graduated under old curriculum</td>
                <td colspan="3">***ALS A&E - Alternative Learning System Accred. & Equiv. Test</td>
            </tr>
            <tr style="font-size:5pt; font-style:italic;">
                <td colspan="5">**PEPT - Philippine Educational Placement Test</td>
            </tr>
        </table>

        ${renderSemester(d.semester1)}
        ${renderSemester(d.semester2)}
    `;
    container.appendChild(page1);

    // === PAGE 2 ===
    const page2 = document.createElement('div');
    page2.className = 'paper';
    page2.innerHTML = `
        <div style="text-align:right; font-size:6pt; margin-bottom:3px;">Page 2 &nbsp; Form 137-SHS</div>
        ${renderSemester(d.semester3)}
        ${renderSemester(d.semester4)}
        
        <table class="form clean-tbl">
            <tr>
                <td width="70%" class="flex-cell">Track/Strand Accomplished:&nbsp;<input class="flex-inp" value="${d.certification.trackStrand}" disabled></td>
                <td width="30%" class="flex-cell">SHS General Average:&nbsp;<input class="flex-inp" value="${d.certification.genAve}" disabled></td>
            </tr>
            <tr>
                <td class="flex-cell">Awards/Honors Received:&nbsp;<input class="flex-inp" value="${d.certification.awards}" disabled></td>
                <td class="flex-cell">Date of SHS Graduation:&nbsp;<input type="date" class="flex-inp" value="${d.certification.gradDate}" disabled></td>
            </tr>
        </table>

        <div style="border:1px solid #000; padding:3px; margin-top:2px; font-size:5.5pt;">
            <strong>Certified by:</strong>
            <div style="padding:12px 0 4px; text-align:center;">
                <div style="display:inline-block; width:220px; border-bottom:1px solid #000; margin-bottom:1px;"></div>
                <div style="font-size:5pt;">Signature of School Head over Printed Name</div>
                <div style="margin-top:6px; font-size:5.5pt;">Date: <input type="date" class="inp" value="${d.certification.certDate}" disabled style="width:80px; border-bottom:1px solid #000;"></div>
            </div>
            <div style="text-align:right; margin-top:6px; font-size:5pt;">Place School Seal Here:</div>
        </div>

        <div style="border:1px solid #000; padding:2px; margin-top:2px; background:#f5f5f5;">
            <div style="font-weight:bold; font-size:5.5pt;">NOTE:</div>
            <div style="font-size:5pt;">This permanent record or a photocopy may be given to the student upon written request.</div>
        </div>

        <div style="border:1px solid #000; padding:2px; margin-top:2px;">
            <div style="font-weight:bold; font-size:5.5pt;">REMARKS: (Purpose for which this form is being requested)</div>
            <textarea class="inp" style="min-height:25px; font-size:5.5pt;" disabled>${d.certification.remarks}</textarea>
            <div style="font-size:5.5pt;">Date Issued (MM/DD/YYYY): <input type="date" class="inp" value="${d.certification.dateIssued}" disabled style="width:80px; border-bottom:1px solid #000;"></div>
        </div>
    `;
    container.appendChild(page2);
}

function renderSemester(sem) {
    if (!sem) return '';
    return `
        <div class="hdr">SCHOLASTIC RECORD</div>
        <table class="form clean-tbl">
            <tr>
                <td width="43%" class="flex-cell">SCHOOL:&nbsp;<input class="flex-inp" value="${sem.school}" disabled></td>
                <td width="18%" class="flex-cell">SCHOOL ID:&nbsp;<input class="flex-inp" value="${sem.schoolId}" disabled></td>
                <td width="18%" class="flex-cell">GRADE LEVEL:&nbsp;<input class="flex-inp" value="${sem.gradeLevel}" disabled></td>
                <td width="21%" class="flex-cell">SY:&nbsp;<input class="flex-inp" value="${sem.sy}" disabled></td>
            </tr>
            <tr>
                <td colspan="3" class="flex-cell">TRACK/STRAND:&nbsp;<input class="flex-inp" value="${sem.trackStrand}" disabled></td>
                <td class="flex-cell">SEM:&nbsp;<input class="flex-inp" value="${sem.sem}" disabled></td>
            </tr>
            <tr>
                <td colspan="4" class="flex-cell">SECTION:&nbsp;<input class="flex-inp" value="${sem.section}" disabled></td>
            </tr>
        </table>

        <table class="form" style="font-size:5.5pt;">
            <thead>
                <tr>
                    <th rowspan="2" width="15%">CORE/APPLIED/SPECIALIZED</th>
                    <th rowspan="2" width="42%">SUBJECTS</th>
                    <th colspan="2" width="14%">Quarter</th>
                    <th rowspan="2" width="11%">SEM FINAL</th>
                    <th rowspan="2" width="12%">ACTION TAKEN</th>
                </tr>
                <tr><th width="7%">1ST</th><th width="7%">2ND</th></tr>
            </thead>
            <tbody>
                ${sem.subjects.map((s) => `
                    <tr>
                        <td><input class="inp c" value="${s.type}" disabled></td>
                        <td><input class="inp" value="${s.subject}" disabled></td>
                        <td><input class="inp c" value="${s.q1}" disabled></td>
                        <td><input class="inp c" value="${s.q2}" disabled></td>
                        <td><input class="inp c" value="${s.final}" disabled></td>
                        <td><input class="inp c" value="${s.action}" disabled></td>
                    </tr>
                `).join('')}
            </tbody>
        </table>

        <table class="form">
            <tr><td class="lbl" width="22%">General Ave. for the Semester:</td><td><input class="inp" value="${sem.genAve}" disabled></td></tr>
            <tr><td class="lbl">REMARKS:</td><td><textarea class="inp" style="height:25px; vertical-align:top;" disabled>${sem.remarks}</textarea></td></tr>
        </table>

        <table class="form" style="font-size:5.5pt;">
            <tr>
                <td width="33%">Prepared by: <input class="inp" value="${sem.adviserName}" disabled></td>
                <td width="34%">Certified: <input class="inp" value="${sem.certName}" disabled></td>
                <td width="33%">Date Checked: <input class="inp" value="${sem.dateChecked}" disabled></td>
            </tr>
            <tr><td colspan="3" class="c" style="padding-top:5px; font-size:5pt; font-style:italic;">Signature of Adviser over Printed Name &nbsp; Signature of Authorized Person over Printed Name</td></tr>
        </table>

        <div class="hdr" style="background:#f0f0f0;">REMEDIAL CLASSES</div>
        <table class="form clean-tbl" style="font-size:5.5pt;">
            <tr>
                <td colspan="2">Conducted from: <input class="inp" value="${sem.remedial.from}" disabled style="width:50px;"></td>
                <td>to: <input class="inp" value="${sem.remedial.to}" disabled style="width:50px;"></td>
                <td class="lbl">SCHOOL:</td><td><input class="inp" value="${sem.remedial.school}" disabled></td>
                <td class="lbl">SCHOOL ID:</td><td><input class="inp" value="${sem.remedial.schoolId}" disabled></td>
            </tr>
        </table>
        <table class="form" style="font-size:5.5pt;">
            <thead>
                <tr>
                    <th width="15%">CORE/APPLIED/SPECIALIZED</th>
                    <th width="39%">SUBJECTS</th>
                    <th width="11%">SEM FINAL</th>
                    <th width="12%">REMEDIAL MARK</th>
                    <th width="13%">RECOMPUTED</th>
                    <th width="10%">ACTION</th>
                </tr>
            </thead>
            <tbody>
                ${sem.remedial.subjects.map((rs) => `
                    <tr>
                        <td><input class="inp c" value="${rs.type}" disabled></td>
                        <td><input class="inp" value="${rs.subject}" disabled></td>
                        <td><input class="inp c" value="${rs.semGrade}" disabled></td>
                        <td><input class="inp c" value="${rs.remedialMark}" disabled></td>
                        <td><input class="inp c" value="${rs.recomputedGrade}" disabled></td>
                        <td><input class="inp c" value="${rs.action}" disabled></td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
        <table class="form" style="font-size:5.5pt;">
            <tr><td width="50%">Name of Teacher/Adviser: <input class="inp" value="${sem.remedial.teacherName}" disabled></td><td>Signature:</td></tr>
        </table>
    `;
}
